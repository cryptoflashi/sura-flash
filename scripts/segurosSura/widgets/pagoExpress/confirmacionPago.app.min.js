appPagoExpress.controller("confirmationController", function ($scope, $uibModal, pagoExpressService) {

    $scope.$on('$locationChangeStart', function (event, next, current) {
        $scope.changeProgress(2);
        event.preventDefault();
    });


    gtag(
        'config',
        'UA-92878313-1', {
        page_tittle: 'confirmacion',
        page_location: window.location.href.toLowerCase() + '#confirmacion',
        page_path: window.location.pathname.toLowerCase() + '#confirmacion'
    }
    );

    $scope.newCard = {};
    $scope.imgs = srcHistoryImgs;


    $scope.tooltipConf = {
        icon: "fa-info-circle",
        template: "info",
        tittle: "Imprimir",
        message: "Imprime tu recibo para pagar en el banco.",
        placement: "top"
    };

    $scope.tooltipConfBtnbc = {
        icon: "fa-info-circle",
        template: "info",
        tittle: "Bancolombia",
        message: "Cuentas de ahorro y corriente. Los recibos que seleccionaste deben sumar un valor menor a $20’000.000. Aplica solo para personas naturales.",
        placement: "top"
    };

    $scope.tooltipConfMedios = {
        icon: "fa-info-circle",
        template: "info",
        tittle: "Otros medios de pago",
        message: "Cuentas de ahorro y corrientes de otros bancos. Todas las tarjetas de credito.",
        placement: "top"
    };

    $scope.ltInstallments = [];


    for (var i = 1; i < 37; i++) {
        $scope.ltInstallments.push({ value: i, text: i });
    }

    var setInformation = function () {
        $scope.payment = pagoExpressService.payment;

        $scope.payments = {
            data: $scope.payment.detailPayment,
            amount: $scope.payment.redirectRequest.payment.amount
        };

        //$scope.valBTNBCPayment = $scope.payments.amount.total < 5000000;

    }

    if (!nullObjectValidate(pagoExpressService.payment)) {

        var methods = pagoExpressService.payment.redirectRequest.paymentMethod;

        $scope.valOnlinePayment =
            (methods.indexOf("BARCODE") > -1 && methods.length > 8) ||
            (methods.indexOf("BARCODE") == -1 && methods.length > 0);


        $scope.useMultiCards = methods.split(",").filter(
            function (a) {
                return creditCardsMethods.some(
                    function (b) {
                        return a == b;
                    }
                );
            }
        ).length > 0;


        $scope.valOfflinePayment = methods.indexOf("BARCODE") > -1;

        $scope.valBTNBCPayment = methods.indexOf("BTNBC") > -1;

        if ($scope.valOnlinePayment) {
            $scope.showLoader(false);
            setInformation();
            /*
            var query = {
                documentType : pagoExpressService.payment.redirectRequest.buyer.documentType,
                document : pagoExpressService.payment.redirectRequest.buyer.document
            };
        	
            pagoExpressService.usertokens(query).then(
                function(result){
                    if(result.token.length > 0){

                        result.token.forEach(
                            function(t){
                                t.disable = true;
                            }
                        );
                    	
                        $scope.InfoTokens = result.token;
                    }
                	
                    setInformation();
                },
                function(error){
                    swal(
                        {
                            title: "Fallo Servicio de consulta",
                            text: "No se pudo generar la consultar, Intente de nuevo mas tarde!", 
                            icon: "error",
                            buttons: {
                                accept: {
                                    text: "Aceptar"
                                }
                            }
                        }
                    );
                }
            )['finally'](
                function(){
                    $scope.showLoader(false);
                }
            );
            */
        } else {
            setInformation();
        }

    } else {
        $scope.changeProgress(1);
    }


    var validateRemove = function (row, data) {
        var fees = "";

        var ltFees = data.filter(
            function (i) {
                var validation = i.reference1 == row.reference1;
                validation = validation && Number(row.reference) < Number(i.reference);

                return validation;
            }
        );

        ltFees.forEach(
            function (i) {
                fees += i.reference + ", ";
            }
        );

        fees = fees.substring(0, fees.length - 2);
        var p = ltFees.length > 1 ? "s" : "";

        var span = document.createElement("span");
        span.appendChild(document.createTextNode(fees));


        if (data.length > 1) {
            data.splice(
                data.indexOf(row),
                1
            );

            $scope.payment.redirectRequest.payment.amount.total = 0.0;
            for (var p in data) {
                $scope.payment.redirectRequest.payment.amount.total += data[p].amount.total;
            }

            swal("Se eliminó el recibo satisfactoriamente!", { icon: "success", });
        } else {
            $scope.changeProgress(2);
        }
    };

    $scope.remove = function (row, info) {

        swal({
            title: "Eliminar Recibo",
            text: "¿Estás seguro que deseas eliminar el recibo?",
            icon: "warning",
            buttons: {
                cancel: "Cancelar",

                accept: {
                    text: "Aceptar",
                    value: true
                }
            }
        })
            .then(
                function (answer) {
                    if (answer) {
                        validateRemove(row, info.data);
                        $scope.$apply();
                    }
                }
            );

    };

    $scope.selectToken = function (token) {
        $scope.InfoTokens.forEach(
            function (t) {
                t.cvv = t.installment = "";
                t.disable = true;
            }
        );

        token.disable = false;
    };

    $scope.gridConfig = {
        footer: {
            lPad: 1,
            lPadRes: true,
            stClass: 'text-right'
        },
        columns: [{
            colResponsive: 1,
            label: '# Recibo',
            fmt: {
                val: 'reference'
            }
        },
        {
            colResponsive: 2,
            label: '# Póliza',
            fmt: {
                val: 'reference1'
            }
        },

        {
            colResponsive: 3,
            label: 'Valor',
            stClass: 'text-right',
            fmt: {
                type: 'currency',
                symbol: '$',
                fractionSize: 0,
                val: 'amount.total'
            }
        },

        {
            colResponsive: 0,
            columntype: 'action',
            stClass: '',
            fmt: [{
                icon: 'fa fa-trash',
                fn: $scope.remove
            }]
        }
        ]
    };

    /*
    $scope.gridTokens = {
    	
        columns : [
            {
                colResponsive : 1,
                label:'Tarjeta',
                fmt: {
                    type : 'images',
                    val:	"franchise"
                }
            },
            {
                colResponsive : 3,
                label:'Número',
                fmt: {
                    val: 'lastDigits'
                }
            },
            {
                colResponsive : 2,
                label:'CVV',
                columntype : 'input',
                fmt: {
                    type : 'text',
                    model: 'cvv',
                    maxLength : maxLengthCVV,
                    onlyNumber : true,
                    disableCtrlC : true,
                    disableCtrlV : true
                }
            },
            {
                colResponsive : 4,
                label:'Cuotas',
                columntype : 'input',
                fmt: {
                    type : 'select',
                    model: 'installment',
                    list :  ltInstallments
                }
            }
        ]
    };
    */

    $scope.pay = function () {

        if (nullObjectValidate($scope.method)) {
            swal({
                title: "Fallo Servicio de Pago",
                text: "No se pudo generar el pago, Intente de nuevo mas tarde!",
                icon: "error",
                buttons: {
                    accept: {
                        text: "Aceptar"
                    }
                }
            });
            return;
        }

        $scope.showLoader(true);

        var request = cloneJson($scope.payment);

        delete request.redirectRequest.payment.amount.snTotal;
        delete request.redirectRequest.payment.amount.dsTotal;

        request.redirectRequest.payment.amount.currency = "COP";

        if ($scope.method == 'online') {
            request.redirectRequest.paymentMethod = methods.replace("BARCODE", "").replace(",,", ",");
            request.redirectRequest.payment.allowPartial = $scope.allowPartial;

            $scope.onlineMethod(request);
        } else if ($scope.method == 'btnbc') {
            request.redirectRequest.paymentMethod = "BTNBC";
            request.redirectRequest.payment.allowPartial = $scope.allowPartial;

            $scope.onlineMethod(request);

        } else {
            $scope.offlineMethod(request);
        }

        gtag(
            'config',
            'UA-92878313-1', {
            page_tittle: 'place_to_pay',
            page_location: window.location.href.toLowerCase() + '#place_to_pay',
            page_path: window.location.pathname.toLowerCase() + '#place_to_pay'
        }
        );

        goToTop("s4-workspace");

    };

    $scope.onlineMethod = function (request) {

        pagoExpressService.pay(request).then(
            function (result) {

                if ("OK" == result.status.status) {
                    localStorage.idPayment = result.cdAviso;
                    localStorage.token = token;
                    window.location = result.processUrl;
                } else {

                    swal({
                        title: "Fallo Servicio de Pago",
                        text: "No se pudo generar el pago, Intente de nuevo mas tarde!",
                        icon: "error",
                        buttons: {
                            accept: {
                                text: "Aceptar"
                            }
                        }
                    });
                }
            },
            function (error) {
                $scope.showLoader(false);
                if (error.statusCode == 403) {
                    $scope.endSession();
                }

                /*
                 * LISTA DE POSIBLES ERRORES 
                 */
                else if (!nullObjectValidate(error.errors)) {

                    var err = getErrorObject(error);
                    var title = "Falló el pago";

                    switch (err.httpErrorCode) {
                        case 'ERR-MULTI-CARDS-01':
                            swal({
                                title: "Multiples Tarjetas",
                                text: err.businessError,
                                icon: "warning",
                                buttons: {
                                    cancel: "Cancelar",

                                    accept: {
                                        text: "Aceptar",
                                        value: true
                                    }
                                }
                            })
                                .then(
                                    function (answer) {
                                        if (answer) {
                                            $scope.allowPartial = false;
                                            $scope.$apply();
                                            $scope.pay();
                                        }
                                    }
                                );
                            break;
                        default:
                            swal({
                                title: title,
                                text: err.businessError,
                                icon: "error",
                                buttons: {
                                    accept: {
                                        text: "Aceptar"
                                    }
                                }
                            });
                            break;
                    }
                } else {

                    swal({
                        title: title,
                        text: "No se pudo generar el pago, Intente de nuevo mas tarde!",
                        icon: "error",
                        buttons: {
                            accept: {
                                text: "Aceptar"
                            }
                        }
                    });
                }
            }
        )['finally'](
            function () {
                goToTop("s4-workspace");
            }
        );
    };

    $scope.offlineMethod = function (request) {

        delete request.redirectRequest.expiration;
        delete request.redirectRequest.returnUrl;

        request.detailPayment = request.detailPayment.map(factura =>{
            if (factura.receipt == "TOTAL")
            {
                factura.reference = factura.amount.total <= factura.amount.totalVal ? "88" : "99";
            }
            return factura;
        });

        pagoExpressService.paymentReceipt(request).then(
            function (result) {


                window.open(result.direccionUrl);

                $scope.changeProgress(1);
            },
            function (error) {
                $scope.showLoader(false);

                if (error == 403) {
                    $scope.endSession();
                } else {

                    error = getErrorObject(error);

                    swal({
                        title: "Falló el pago",
                        text: error.businessError ? error.businessError : "No se pudo generar el pago, Intente de nuevo mas tarde!",
                        icon: "error",
                        buttons: {
                            accept: {
                                text: "Aceptar"
                            }
                        }
                    });
                }
            }
        )['finally'](
            function () {
                $scope.showLoader(false);
                goToTop("s4-workspace");
            }
        );

        
    };


    $scope.getCreditCardType = function () {
        $scope.newCard.franchise = getCreditCardType($scope.newCard.number);
    }

    goToTop("s4-workspace");
});